<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pea Chat</title>

  <style>
    /* =====================================
       GLOBAL / RESET
    ======================================*/
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Inter", Arial, sans-serif;
      background: linear-gradient(135deg, #8b5cf6, #4f46e5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    /* =====================================
       MAIN CHAT WRAPPER
    ======================================*/
    .chatbot {
      width: 100%;
      max-width: 780px;
      display: flex;
      flex-direction: column;
      border-radius: 20px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      animation: fadeIn 0.6s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* =====================================
       HEADER
    ======================================*/
    .chat-header {
      padding: 1.3em;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
      color: #fff;
      text-align: center;
      font-weight: bold;
    }
    .chat-header h1 {
      font-size: 2em;
    }
    .meta { font-size: .9em; opacity: .9; }

    /* =====================================
       TABS
    ======================================*/
    .tabs {
      display: flex;
      background: #e4e0ff;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.25s;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      background: #fff;
      border-bottom: 3px solid #7b58e5;
    }

    /* =====================================
       CHAT AREA
    ======================================*/
    .chat-messages {
      flex: 1;
      height: 500px;
      overflow-y: auto;
      padding: 1em;
      display: flex;
      flex-direction: column;
      gap: 0.8em;
    }

    .message {
      display: flex;
      align-items: flex-start;
      gap: 0.7em;
      animation: fadeIn 0.3s ease;
    }

    .user p {
      background-color: #7B58E5;
      color: #fff;
      padding: 0.6em 1em;
      border-radius: 18px 18px 0 18px;
      max-width: 85%;
      margin-left: auto;
      white-space: pre-wrap;
    }
    .aibot p {
      background-color: #ececec;
      color: #000;
      padding: 0.6em 1em;
      border-radius: 18px 18px 18px 0;
      max-width: 85%;
      white-space: pre-wrap;
    }

    /* Typing animation */
    .typing {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 4px;
      background: #666;
      animation: blink 1s infinite ease-in-out;
    }
    @keyframes blink {
      0% { opacity: .2; }
      50% { opacity: 1; }
      100% { opacity: .2; }
    }

    /* =====================================
       MESSAGE FORM
    ======================================*/
    .chat-form {
      display: flex;
      padding: 1em;
      border-top: 1px solid #ddd;
      gap: 0.5em;
      background: #fafafa;
    }

    .chat-form textarea {
      flex: 1;
      padding: 0.8em 1em;
      border-radius: 18px;
      border: 1px solid #ddd;
      resize: none;
      font-size: 1em;
      min-height: 45px;
      max-height: 100px;
    }

    .chat-form button {
      background-color: #7B58E5;
      color: #fff;
      border: none;
      padding: 0 18px;
      border-radius: 18px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 1.1em;
    }
    .chat-form button:hover {
      background-color: #633ad9;
    }

    /* =====================================
       TOOLS PANEL
    ======================================*/
    #tools-panel {
      display: none;
      padding: 1.3em;
      background: #fafafa;
    }

    #tools-panel textarea {
      width: 100%;
      height: 160px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #bbb;
    }
    #tools-panel select, 
    #tools-panel input {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid #bbb;
    }
    #tools-panel button {
      margin-top: 16px;
      width: 100%;
      padding: 12px;
      background: #7B58E5;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05em;
    }

    /* Result Box */
    #tools-result {
      margin-top: 18px;
      padding: 14px;
      background: #f1ecff;
      border-left: 4px solid #7B58E5;
      border-radius: 10px;
      display: none;
      white-space: pre-wrap;
      animation: fadeIn 0.4s;
    }

    /* =====================================
       LOGIN POPUP
    ======================================*/
    #login-popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #login-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      animation: fadeIn 0.5s;
    }

    #login-card input {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #login-card button {
      width: 100%;
      padding: 12px;
      margin-top: 16px;
      background: #7B58E5;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.05em;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- LOGIN POPUP -->
<div id="login-popup">
  <div id="login-card">
    <h3>Sign in</h3>
    <input id="login-user" placeholder="username" />
    <input id="login-pass" type="password" placeholder="password" />
    <button id="login-btn">Login</button>
    <p id="login-error" style="color:red"></p>
  </div>
</div>

<main>
  <div class="chatbot">

    <div class="chat-header">
      <h1>Pea ðŸ«›</h1>
      <div class="meta" id="who"></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" id="tab-chat">ðŸ’¬ Chat</div>
      <div class="tab" id="tab-tools">ðŸ›  Tools</div>
    </div>

    <!-- CHAT PAGE -->
    <div id="chat-page">
      <div class="chat-messages" id="messages-container"></div>

      <form class="chat-form" id="message-form">
        <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
        <button type="button" id="mic-btn">ðŸŽ¤</button>
        <button type="submit">âž¤</button>
      </form>
    </div>

    <!-- TOOLS PAGE -->
    <div id="tools-panel">
      <textarea id="tools-text" placeholder="Enter text..."></textarea>

      <select id="tools-mode">
        <option value="summarize">Summarize</option>
        <option value="translate">Translate</option>
        <option value="rewrite">Rewrite</option>
      </select>

      <input id="tools-extra" placeholder="Target language / style (optional)" />

      <button id="tools-run">Run with LLaMA</button>

      <!-- Results Box -->
      <div id="tools-result"></div>
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* ==============================
   CONFIG
=================================*/
const API_BASE = "https://ej-0-training.hf.space";

/* ==============
   DOM ELEMENTS
=================*/
const messagesContainer = document.getElementById('messages-container');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const micBtn = document.getElementById('mic-btn');

const whoEl = document.getElementById('who');

const tabChat = document.getElementById("tab-chat");
const tabTools = document.getElementById("tab-tools");
const chatPage = document.getElementById("chat-page");
const toolsPanel = document.getElementById("tools-panel");

const loginPopup = document.getElementById('login-popup');
const loginBtn = document.getElementById('login-btn');
const loginUser = document.getElementById('login-user');
const loginPass = document.getElementById('login-pass');
const loginError = document.getElementById('login-error');

let SESSION_ID = null;

/* ==============================
   TAB SWITCHING
=================================*/
function switchTab(tab) {
  if (tab === "chat") {
    tabChat.classList.add("active");
    tabTools.classList.remove("active");
    chatPage.style.display = "block";
    toolsPanel.style.display = "none";
  } else {
    tabTools.classList.add("active");
    tabChat.classList.remove("active");
    chatPage.style.display = "none";
    toolsPanel.style.display = "block";
  }
}

tabChat.onclick = () => switchTab("chat");
tabTools.onclick = () => switchTab("tools");

/* ==============================
   MESSAGE HELPER
=================================*/
function addMessage(text, role) {
  const wrapper = document.createElement("div");
  wrapper.className = "message " + role;

  const bubble = document.createElement("p");
  bubble.innerHTML = marked.parse(text);

  wrapper.appendChild(bubble);
  messagesContainer.appendChild(wrapper);
  messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: "smooth" });
}

/* ==============================
   LOGIN
=================================*/
loginBtn.onclick = async () => {
  loginError.innerText = "";
  const username = loginUser.value.trim();
  const password = loginPass.value.trim();

  const res = await fetch(API_BASE + "/login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if (data.success) {
    SESSION_ID = data.session_id;
    loginPopup.style.display = "none";
    whoEl.innerText = `Signed in as: ${SESSION_ID}`;
    addMessage(`Welcome back, ${SESSION_ID}!`, "aibot");
  } else {
    loginError.innerText = "Invalid login.";
  }
};

/* ==============================
   SEND CHAT MESSAGE
=================================*/
async function sendMessage(text) {
  if (!SESSION_ID) {
    addMessage("Please login first.", "aibot");
    return;
  }

  addMessage(text, "user");

  const loading = document.createElement("p");
  loading.className = "loading-text";
  loading.innerText = "AI is typing...";
  messagesContainer.appendChild(loading);

  const res = await fetch(API_BASE + "/chatbot", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ prompt: text, session_id: SESSION_ID })
  });

  const data = await res.json();

  loading.remove();
  addMessage(data.response || "No response", "aibot");
}

messageForm.addEventListener("submit", e => {
  e.preventDefault();
  const text = messageInput.value.trim();
  if (!text) return;
  messageInput.value = "";
  sendMessage(text);
});

/* ==============================
   MIC BUTTON / SPEECH TO TEXT
=================================*/
let mediaRecorder = null;
let audioChunks = [];
let recording = false;

micBtn.addEventListener("click", async () => {
  if (!recording) {
    // Start recording
    if (!navigator.mediaDevices?.getUserMedia) {
      alert("Your browser does not support microphone recording.");
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

      const formData = new FormData();
      formData.append("file", audioBlob, "speech.webm");

      try {
        const res = await fetch(API_BASE + "/asr", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        const text = data.text;

        messageInput.value = text;
        await sendMessage(text);

      } catch (err) {
        console.error(err);
        addMessage("Error during speech recognition.", "aibot");
      }
    };

    mediaRecorder.start();
    recording = true;
    micBtn.innerText = "â¹ï¸";   // stop icon

  } else {
    // Stop recording
    recording = false;
    micBtn.innerText = "ðŸŽ¤";
    mediaRecorder.stop();
  }
});

/* ==============================
   TOOLS (LLAMA)
=================================*/
document.getElementById("tools-run").onclick = async () => {
  const text = document.getElementById("tools-text").value.trim();
  const task = document.getElementById("tools-mode").value;
  const extra = document.getElementById("tools-extra").value.trim();

  if (!text) {
    alert("Enter some text.");
    return;
  }

  const body = { text, task };
  if (task === "translate") body.to = extra || "english";
  if (task === "rewrite") body.style = extra || "normal";

  const res = await fetch(API_BASE + "/llama", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });

  const data = await res.json();

  // â˜… Replace alert with UI box (already added earlier)
  document.getElementById("tools-result").innerText = data.result;
};

/* ==============================
   AUTO FOCUS LOGIN FIELD
=================================*/
window.onload = () => loginUser.focus();
</script>


</body>
</html>
