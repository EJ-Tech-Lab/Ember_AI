<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pea Chat</title>

  <style>
    /* =====================================
       GLOBAL / RESET
    ======================================*/
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Inter", Arial, sans-serif;
      background: linear-gradient(135deg, #8b5cf6, #4f46e5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    /* =====================================
       MAIN CHAT WRAPPER
    ======================================*/
    .chatbot {
      width: 100%;
      max-width: 780px;
      display: flex;
      flex-direction: column;
      border-radius: 20px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      animation: fadeIn 0.6s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* =====================================
       HEADER
    ======================================*/
    .chat-header {
      padding: 1.3em;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
      color: #0f0;
      text-align: center;
      font-weight: bold;
    }
    .chat-header h1 {
      font-size: 2em;
    }
    .meta { font-size: .9em; opacity: .9; }

    /* =====================================
       CHAT AREA
    ======================================*/
    .chat-messages {
      flex: 1;
      height: 500px;
      overflow-y: auto;
      padding: 1em;
      display: flex;
      flex-direction: column;
      gap: 0.8em;
    }

    .message {
      display: flex;
      align-items: flex-start;
      gap: 0.7em;
      animation: fadeIn 0.3s ease;
    }

    .user p {
      background-color: #7B58E5;
      color: #fff;
      padding: 0.6em 1em;
      border-radius: 18px 18px 0 18px;
      max-width: 85%;
      margin-left: auto;
      white-space: pre-wrap;
    }
    .aibot p {
      background-color: #ececec;
      color: #000;
      padding: 0.6em 1em;
      border-radius: 18px 18px 18px 0;
      max-width: 85%;
      white-space: pre-wrap;
    }

    /* Typing animation */
    .typing {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 4px;
      background: #666;
      animation: blink 1s infinite ease-in-out;
    }
    @keyframes blink {
      0% { opacity: .2; }
      50% { opacity: 1; }
      100% { opacity: .2; }
    }

    /* =====================================
       MESSAGE FORM
    ======================================*/
    .chat-form {
      display: flex;
      padding: 1em;
      border-top: 1px solid #ddd;
      gap: 0.5em;
      background: #fafafa;
    }

    .chat-form textarea {
      flex: 1;
      padding: 0.8em 1em;
      border-radius: 18px;
      border: 1px solid #ddd;
      resize: none;
      font-size: 1em;
      min-height: 45px;
      max-height: 100px;
    }

    .chat-form button {
      background-color: #7B58E5;
      color: #fff;
      border: none;
      padding: 0 18px;
      border-radius: 18px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 1.1em;
    }
    .chat-form button:hover {
      background-color: #633ad9;
    }
    /* =====================================
       LOGIN POPUP
    ======================================*/
    #login-popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #login-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      animation: fadeIn 0.5s;
    }

    #login-card input {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #login-card button {
      width: 100%;
      padding: 12px;
      margin-top: 16px;
      background: #7B58E5;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.05em;
      cursor: pointer;
    }
    #switch-mode {
      margin-top: 10px;
      color: #7B58E5;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9em;
      text-align: center;
    }
  </style>
</head>
<body>
    <!-- LOGIN POPUP -->
    <div id="login-popup">
        <div id="login-card">

            <h3 id="login-title">Sign in</h3>

            <input id="login-user" placeholder="username" />
            <input id="login-pass" type="password" placeholder="password" />

            <!-- Appears only in signup mode -->
            <input id="login-pass2" type="password" placeholder="confirm password" style="display:none;" />

            <button id="login-btn">Login</button>

            <p id="login-error" style="color:red"></p>

            <div id="switch-mode">Don't have an account? Sign up</div>
        </div>
    </div>

    <main>
        <div class="chatbot">
            <div class="chat-header">
                <h1>Pea ðŸ«›</h1>
                <div class="meta" id="who"></div>
              <button id="logout-btn">Logout</button>

            </div>

            <div id="chat-page">
                <div class="chat-messages" id="messages-container"></div>
                <form class="chat-form" id="message-form">
    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>

    <!-- Upload button -->
    <button type="button" id="file-btn">ðŸ“Ž</button>
    <input type="file" id="file-input" style="display:none;" multiple />

    <!-- Mic -->
    <button type="button" id="mic-btn">ðŸŽ¤</button>

    <!-- Send -->
    <button type="submit">âž¤</button>
</form>

            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* ============================== CONFIG ============================== */
const API_BASE = "https://ej-0-training.hf.space";

/* ============== DOM ELEMENTS ================= */
const messagesContainer = document.getElementById('messages-container');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const micBtn = document.getElementById('mic-btn');
const whoEl = document.getElementById('who');

const loginPopup = document.getElementById('login-popup');
const loginBtn = document.getElementById('login-btn');
const loginUser = document.getElementById('login-user');
const loginPass = document.getElementById('login-pass');
const loginPass2 = document.getElementById('login-pass2');
const loginTitle = document.getElementById('login-title');
const loginError = document.getElementById('login-error');
const switchMode = document.getElementById('switch-mode');
const logoutBtn = document.getElementById('logout-btn');
  const fileBtn = document.getElementById("file-btn");
const fileInput = document.getElementById("file-input");

let ACCESS_TOKEN = null;
let CURRENT_USERNAME = null;
let isSignupMode = false;

/* ============================== MESSAGE HELPER ============================== */
function addMessage(text, role) {
    const wrapper = document.createElement("div");
    wrapper.className = "message " + role;

    const bubble = document.createElement("p");
    bubble.innerHTML = marked.parse(text);

    wrapper.appendChild(bubble);
    messagesContainer.appendChild(wrapper);
    messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: "smooth" });
}
//=============================================
logoutBtn.onclick = async () => {
    try {
        await fetch(API_BASE + "/logout", {
            method: "POST",
            credentials: "include",
            headers: ACCESS_TOKEN ? { "Authorization": "Bearer " + ACCESS_TOKEN } : {}
        });
    } catch (e) {
        console.warn("Logout request failed:", e);
    }

    ACCESS_TOKEN = null;
    CURRENT_USERNAME = null;
    whoEl.innerText = "Not signed in";
    loginPopup.style.display = "flex";
    addMessage("You have been logged out.", "aibot");
};

/* ============================== LOGIN / SIGNUP SWITCH ============================== */
switchMode.onclick = () => {
    isSignupMode = !isSignupMode;

    if (isSignupMode) {
        loginTitle.innerText = "Sign up";
        loginBtn.innerText = "Create Account";
        switchMode.innerText = "Already have an account? Sign in";
        loginPass2.style.display = "block";
    } else {
        loginTitle.innerText = "Sign in";
        loginBtn.innerText = "Login";
        switchMode.innerText = "Don't have an account? Sign up";
        loginPass2.style.display = "none";
    }

    loginError.innerText = "";
};

/* ============================== LOGIN / SIGNUP REQUEST ============================== */
loginBtn.onclick = async () => {
    loginError.innerText = "";
    const username = loginUser.value.trim();
    const password = loginPass.value.trim();

    if (!username || !password) {
        loginError.innerText = "Fill all fields.";
        return;
    }

    if (isSignupMode) {
        const password2 = loginPass2.value.trim();
        if (password !== password2) {
            loginError.innerText = "Passwords do not match.";
            return;
        }

        const res = await fetch(API_BASE + "/signup", {
            method: "POST",
          credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!data.success) {
            loginError.innerText = data.message || "Signup failed.";
            return;
        }

        loginError.innerText = "Account created! Please sign in.";
        isSignupMode = false;
        loginTitle.innerText = "Sign in";
        loginBtn.innerText = "Login";
        switchMode.innerText = "Don't have an account? Sign up";
        loginPass2.style.display = "none";
        return;
    }

    // LOGIN
    const res = await fetch(API_BASE + "/login", {
        method: "POST",
      credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await res.json();
    if (!data.success) {
        loginError.innerText = "Invalid username or password.";
        return;
    }

    ACCESS_TOKEN = data.access_token;
    try {
        const decoded = JSON.parse(atob(ACCESS_TOKEN.split(".")[1]));
        CURRENT_USERNAME = decoded.sub;
    } catch (e) {
        CURRENT_USERNAME = username;
    }

    loginPopup.style.display = "none";
    whoEl.innerText = `Signed in as: ${CURRENT_USERNAME}`;
    addMessage(`Welcome back, ${CURRENT_USERNAME}!`, "aibot");
};

async function refreshAccessToken() {
    try {
        const res = await fetch(API_BASE + "/auth/refresh", {
            method: "POST",
            credentials: "include" // ensure cookie is sent
        });

        if (!res.ok) {
            console.log("Refresh failed (status " + res.status + ")");
            return false;
        }

        const data = await res.json();
        if (!data.access_token) return false;
        ACCESS_TOKEN = data.access_token;

        // update CURRENT_USERNAME from new token if possible
        try {
            const decoded = JSON.parse(atob(ACCESS_TOKEN.split(".")[1]));
            CURRENT_USERNAME = decoded.sub;
            whoEl.innerText = `Signed in as: ${CURRENT_USERNAME}`;
        } catch (e) {}

        console.log("Access token refreshed!");
        return true;
    } catch (e) {
        console.error("Refresh error:", e);
        return false;
    }
}

/* ============================== TYPING ANIMATION ============================== */
function showTyping() {
    const bubble = document.createElement("div");
    bubble.className = "message aibot";
    bubble.id = "typingBubble";
    bubble.innerHTML = `<div class="typing"></div>`;
    messagesContainer.appendChild(bubble);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTyping() {
    const el = document.getElementById("typingBubble");
    if (el) el.remove();
}

/* ============================== SEND CHAT MESSAGE ============================== */
async function sendMessage(text) {
    if (!ACCESS_TOKEN) return addMessage("Please login first.", "aibot");

    addMessage(text, "user");
    showTyping();

    let res;
    try {
        res = await fetch(API_BASE + "/chatbot", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + ACCESS_TOKEN
            },
            body: JSON.stringify({ prompt: text })
        });
    } catch (err) {
        removeTyping();
        addMessage("Network error when sending message.", "aibot");
        return;
    }

    // If access expired, try to refresh once then retry
    if (res.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
            try {
                res = await fetch(API_BASE + "/chatbot", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + ACCESS_TOKEN
                    },
                    body: JSON.stringify({ prompt: text })
                });
            } catch (err) {
                removeTyping();
                addMessage("Network error when retrying message.", "aibot");
                return;
            }
        } else {
            removeTyping();
            addMessage("Session expired. Please log in again.", "aibot");
            // show login popup
            loginPopup.style.display = "flex";
            return;
        }
    }

    const data = await res.json();
    removeTyping();

    if (!res.ok) {
        // show helpful message from backend if present
        addMessage(data.detail || data.response || "Error from server", "aibot");
        return;
    }

    addMessage(data.response || "No response", "aibot");
}

messageForm.addEventListener("submit", e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    messageInput.value = "";
    sendMessage(text);
});

/* ============================== MIC BUTTON / ASR ============================== */
let mediaRecorder = null;
let audioChunks = [];
let recording = false;

micBtn.addEventListener("click", async () => {
    if (!recording) {
        if (!navigator.mediaDevices?.getUserMedia) {
            alert("Your browser does not support microphone recording.");
            return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const formData = new FormData();
            formData.append("file", audioBlob, "speech.webm");

            try {
                const res = await fetch(API_BASE + "/asr", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + ACCESS_TOKEN },
                    body: formData
                });
                const data = await res.json();
                const text = data.text;
                messageInput.value = text;
                await sendMessage(text);
            } catch (err) {
                console.error(err);
                addMessage("Error during speech recognition.", "aibot");
            }
        };

        mediaRecorder.start();
        recording = true;
        micBtn.innerText = "â¹ï¸";
    } else {
        recording = false;
        micBtn.innerText = "ðŸŽ¤";
        mediaRecorder.stop();
    }
});


/* ============================== AUTO-REFRESH INTERVAL ============================== */
setInterval(() => {
    // only attempt refresh when we have an access token (user logged in)
    if (ACCESS_TOKEN) refreshAccessToken();
}, 10* 60 * 1000 ); // 

/* ============================== AUTO LOGIN ON PAGE LOAD ============================== */
window.onload = async () => {
    loginUser.focus();

    // Try to refresh on load â€” will succeed if refresh cookie exists & server CORS is correct
    const ok = await refreshAccessToken();
    if (ok) {
        loginPopup.style.display = "none";
        addMessage(`Welcome back, ${CURRENT_USERNAME || "user"}!`, "aibot");
    } else {
        // show login
        loginPopup.style.display = "flex";
    }
};

fileBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", async () => {
    if (!ACCESS_TOKEN) {
        addMessage("Please login to upload files.", "aibot");
        return;
    }

    const files = fileInput.files;
    if (!files || files.length === 0) return;

    const formData = new FormData();
    for (let f of files) {
        formData.append("files", f);
    }

    addMessage(`Uploading ${files.length} file(s)...`, "user");
    showTyping();

    try {
        const res = await fetch(API_BASE + "/upload_files", {
            method: "POST",
            headers: { "Authorization": "Bearer " + ACCESS_TOKEN },
            body: formData
        });

        removeTyping();

        const data = await res.json();

        if (!res.ok) {
            addMessage(data.detail || "Upload failed.", "aibot");
            return;
        }

        addMessage(data.message || "Files uploaded successfully.", "aibot");
    } catch (err) {
        removeTyping();
        addMessage("Upload error.", "aibot");
        console.error(err);
    }

    fileInput.value = ""; // clear selection
});

</script>
</body>

</html>
