<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pea Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =====================================
           GLOBAL / RESET
        ======================================*/
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #8b5cf6, #4f46e5);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        /* =====================================
           MAIN LAYOUT (SIDEBAR + CHAT)
        ======================================*/
        .app-container {
            width: 100%;
            max-width: 1100px;
            height: 90vh;
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: rgba(245, 245, 250, 0.9);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .sidebar-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand { font-size: 1.4em; font-weight: bold; color: #7B58E5; }

        .new-chat-btn {
            background: #7B58E5;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            margin-bottom: 10px;
        }

        .new-chat-btn:hover { background: #633ad9; }

        .thread-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .thread-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .thread-item span {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thread-item:hover { background: #e0e7ff; color: #7B58E5; }
        .thread-item.active { background: #7B58E5; color: white; }

        .delete-thread {
            opacity: 0;
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
        }
        .thread-item:hover .delete-thread { opacity: 1; }

        /* USER PROFILE (BOTTOM OF SIDEBAR) */
        .user-profile {
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .logout-link { color: #d946ef; cursor: pointer; text-decoration: underline; }

        /* MAIN CHAT AREA */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* MESSAGES */
        .message { display: flex; align-items: flex-start; gap: 10px; max-width: 80%; animation: fadeIn 0.3s ease; }
        .message.user { margin-left: auto; flex-direction: row-reverse; }
        
        .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95em;
            word-wrap: break-word;
        }

        .message.user .bubble {
            background: #7B58E5;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.aibot .bubble {
            background: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }

        /* CHAT INPUT */
        .chat-input-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            background: #f9fafb;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid #e5e7eb;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            padding: 8px;
            font-family: inherit;
            outline: none;
            max-height: 100px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            transition: 0.2s;
            font-size: 1.1em;
        }
        .icon-btn:hover { color: #7B58E5; }

        .send-btn {
            background: #7B58E5;
            color: white;
            border: none;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-btn:hover { background: #633ad9; }

        /* =====================================
           LOGIN POPUP
        ======================================*/
        #login-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .login-card {
            background: white; padding: 30px;
            border-radius: 16px; width: 350px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-card input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 8px;
        }
        .login-card button {
            width: 100%; padding: 12px;
            background: #7B58E5; color: white;
            border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold;
        }
        .switch-mode {
            margin-top: 15px; font-size: 0.9em;
            color: #7B58E5; cursor: pointer; text-decoration: underline;
        }

        /* UTILS */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; height: 100vh; border-radius: 0; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; padding: 5px; overflow-x: auto; overflow-y: hidden; }
            .new-chat-btn { width: auto; margin: 0; }
            .thread-list { flex-direction: row; }
            .thread-item { width: 150px; }
            .user-profile { display: none; } /* Hide profile on mobile for space */
        }
    </style>
</head>

<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 id="auth-title">Welcome</h2>
            <p id="auth-error" style="color:red; font-size: 0.9em; margin-bottom: 5px;"></p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="auth-btn">Sign In</button>
            <div class="switch-mode" id="toggle-auth">Need an account? Sign Up</div>
        </div>
    </div>

    <div class="app-container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">Pea ü´õ</div>
            </div>
            
            <button class="new-chat-btn" id="new-chat-btn">
                <i class="fas fa-plus"></i> New Chat
            </button>

            <div class="thread-list" id="thread-list">
                </div>

            <div class="user-profile">
                <div id="user-email-display" style="font-weight: bold;"></div>
                <div class="logout-link" id="logout-btn">Log out</div>
            </div>
        </aside>

        <main class="chat-area">
            <div class="chat-header">
                <span id="current-chat-title">New Chat</span>
                <span id="connection-status" style="font-size: 0.8em; color: green;">‚óè Online</span>
            </div>

            <div class="chat-messages" id="messages-container">
                <div style="text-align:center; color:#aaa; margin-top: 50px;">
                    <i class="fas fa-robot" style="font-size: 3em; margin-bottom: 10px;"></i>
                    <p>Select a conversation or start a new one.</p>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <button class="icon-btn" id="file-btn"><i class="fas fa-paperclip"></i></button>
                    <input type="file" id="file-input" class="hidden">
                    
                    <button class="icon-btn" id="mic-btn"><i class="fas fa-microphone"></i></button>
                    
                    <textarea id="message-input" rows="1" placeholder="Type a message..."></textarea>
                    
                    <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIG
        const API_BASE = "https://ej-0-training.hf.space"; 

        // STATE
        let accessToken = localStorage.getItem("access_token");
        let refreshToken = localStorage.getItem("refresh_token");
        let currentEmail = localStorage.getItem("user_email");
        let currentThreadId = null;
        let isSignup = false;

        // DOM ELEMENTS
        const els = {
            overlay: document.getElementById('login-overlay'),
            authBtn: document.getElementById('auth-btn'),
            toggleAuth: document.getElementById('toggle-auth'),
            emailIn: document.getElementById('email'),
            passIn: document.getElementById('password'),
            err: document.getElementById('auth-error'),
            title: document.getElementById('auth-title'),
            
            threadList: document.getElementById('thread-list'),
            newChatBtn: document.getElementById('new-chat-btn'),
            msgContainer: document.getElementById('messages-container'),
            msgInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            fileBtn: document.getElementById('file-btn'),
            fileIn: document.getElementById('file-input'),
            micBtn: document.getElementById('mic-btn'),
            
            chatTitle: document.getElementById('current-chat-title'),
            userDisplay: document.getElementById('user-email-display'),
            logoutBtn: document.getElementById('logout-btn')
        };

        /* ============================================================
           INITIALIZATION
        ============================================================ */
        async function init() {
            if (accessToken && await refreshSession()) {
                showApp();
            } else {
                showLogin();
            }
        }
        window.onload = init;

        function showLogin() {
            els.overlay.classList.remove('hidden');
        }

        function showApp() {
            els.overlay.classList.add('hidden');
            els.userDisplay.innerText = currentEmail;
            loadConversations();
            
            // Start fresh
            currentThreadId = null;
            renderMessages([]);
        }

        /* ============================================================
           AUTH & API HELPERS
        ============================================================ */
        async function apiCall(endpoint, method = "GET", body = null) {
            let headers = { "Content-Type": "application/json" };
            if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;

            let res = await fetch(API_BASE + endpoint, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null
            });

            if (res.status === 401) {
                if (await refreshSession()) {
                    // Retry once with new token
                    headers["Authorization"] = `Bearer ${accessToken}`;
                    res = await fetch(API_BASE + endpoint, { method, headers, body: body ? JSON.stringify(body) : null });
                } else {
                    logout();
                    return null;
                }
            }
            return res;
        }

        async function refreshSession() {
            if (!refreshToken) return false;
            try {
                const res = await fetch(API_BASE + "/auth/refresh", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                if (!res.ok) throw new Error("Refresh failed");
                const data = await res.json();
                accessToken = data.access_token;
                refreshToken = data.refresh_token;
                localStorage.setItem("access_token", accessToken);
                localStorage.setItem("refresh_token", refreshToken);
                return true;
            } catch (e) {
                console.log(e);
                return false;
            }
        }

        /* ============================================================
           SIDEBAR & THREADS
        ============================================================ */
        async function loadConversations() {
            const res = await apiCall("/conversations");
            if (!res) return;
            const data = await res.json();
            renderThreads(data.conversations || []);
        }

        function renderThreads(threads) {
            els.threadList.innerHTML = "";
            threads.forEach(t => {
                const div = document.createElement("div");
                div.className = `thread-item ${t.id === currentThreadId ? 'active' : ''}`;
                div.innerHTML = `
                    <span><i class="far fa-comment-alt"></i> ${t.title || 'Untitled'}</span>
                    <button class="delete-thread" onclick="deleteThread(event, '${t.id}')"><i class="fas fa-trash"></i></button>
                `;
                div.onclick = () => selectThread(t.id, t.title);
                els.threadList.appendChild(div);
            });
        }

        async function selectThread(id, title) {
            if (currentThreadId === id) return;
            currentThreadId = id;
            els.chatTitle.innerText = title || "Chat";
            loadConversations(); // Re-render to update 'active' class
            
            // Load History
            const res = await apiCall(`/conversations/${id}/messages`);
            if (res) {
                const data = await res.json();
                renderMessages(data.messages);
            }
        }

        async function deleteThread(e, id) {
            e.stopPropagation(); // Prevent clicking the thread
            if (!confirm("Delete this chat?")) return;
            
            await apiCall(`/conversations/${id}`, "DELETE");
            
            if (currentThreadId === id) {
                currentThreadId = null;
                els.chatTitle.innerText = "New Chat";
                els.msgContainer.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:50px;">Chat Deleted</div>';
            }
            loadConversations();
        }

        els.newChatBtn.onclick = () => {
            currentThreadId = null;
            els.chatTitle.innerText = "New Chat";
            els.msgContainer.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:50px;"><i class="fas fa-bolt"></i><p>Start a new conversation</p></div>';
            loadConversations(); // Remove active state
        };

        /* ============================================================
           MESSAGING & STREAMING
        ============================================================ */
        function renderMessages(msgs) {
            els.msgContainer.innerHTML = "";
            msgs.forEach(m => appendUI(m.content, m.role === "user" ? "user" : "aibot"));
            scrollToBottom();
        }

        function appendUI(text, role) {
            const div = document.createElement("div");
            div.className = `message ${role}`;
            
            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.innerHTML = marked.parse(text);
            
            div.appendChild(bubble);
            els.msgContainer.appendChild(div);
            scrollToBottom();
            return bubble; // Return for streaming updates
        }

        function scrollToBottom() {
            els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = els.msgInput.value.trim();
            if (!text) return;
            
            els.msgInput.value = "";
            appendUI(text, "user");

            // Create placeholder for AI
            const aiBubble = appendUI("...", "aibot");
            let fullResponse = "";

            try {
                // Determine Payload (include thread_id if exists)
                const payload = { prompt: text };
                if (currentThreadId) payload.thread_id = currentThreadId;

                const response = await fetch(API_BASE + "/chatbot", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if(response.status === 401) {
                    aiBubble.innerText = "Error: Unauthorized. Please refresh.";
                    return;
                }

                // STREAM READER
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = ""; // To hold partial JSON lines

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Decode chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });

                    // Split by newline to get JSON objects
                    let lines = buffer.split("\n");
                    // Keep the last part in buffer (it might be incomplete)
                    buffer = lines.pop(); 

                    for (let line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            // 1. Capture Thread ID (for new chats)
                            if (data.thread_id && !currentThreadId) {
                                currentThreadId = data.thread_id;
                                loadConversations(); // Refresh sidebar to show new chat
                            }

                            // 2. Append Text Chunk
                            if (data.chunk) {
                                fullResponse += data.chunk;
                                aiBubble.innerHTML = marked.parse(fullResponse);
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("JSON Parse Error", e);
                        }
                    }
                }
            } catch (err) {
                aiBubble.innerText = "Network Error.";
            }
        }

        els.sendBtn.onclick = sendMessage;
        els.msgInput.onkeydown = (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        /* ============================================================
           FILE UPLOAD & ASR (Kept from your original)
        ============================================================ */
        // File Upload
        els.fileBtn.onclick = () => els.fileIn.click();
        els.fileIn.onchange = async () => {
             // (Implement upload logic similar to before using apiCall)
             alert("File upload selected (Implement backend endpoint integration here)");
        };

        // ASR
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;

        els.micBtn.onclick = async () => {
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: "audio/webm" });
                    const formData = new FormData();
                    formData.append("file", blob, "audio.webm");
                    
                    els.micBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    const res = await fetch(API_BASE + "/asr", { method:"POST", body:formData });
                    const data = await res.json();
                    els.msgInput.value += data.text + " ";
                    els.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                mediaRecorder.start();
                els.micBtn.innerHTML = '<i class="fas fa-stop" style="color:red"></i>';
                isRecording = true;
            } else {
                mediaRecorder.stop();
                isRecording = false;
            }
        };

        /* ============================================================
           LOGIN / SIGNUP LOGIC
        ============================================================ */
        els.toggleAuth.onclick = () => {
            isSignup = !isSignup;
            els.title.innerText = isSignup ? "Create Account" : "Welcome Back";
            els.authBtn.innerText = isSignup ? "Sign Up" : "Sign In";
            els.toggleAuth.innerText = isSignup ? "Have an account? Sign In" : "Need an account? Sign Up";
        };

        els.authBtn.onclick = async () => {
            const email = els.emailIn.value;
            const password = els.passIn.value;
            els.err.innerText = "";
            
            const endpoint = isSignup ? "/signup" : "/login";
            try {
                const res = await fetch(API_BASE + endpoint, {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    if (isSignup) {
                        els.err.style.color = "green";
                        els.err.innerText = "Success! Check email to confirm.";
                    } else {
                        accessToken = data.access_token;
                        refreshToken = data.refresh_token;
                        currentEmail = email; // Backend doesn't return email in login usually, save from input or adjust backend
                        localStorage.setItem("access_token", accessToken);
                        localStorage.setItem("refresh_token", refreshToken);
                        localStorage.setItem("user_email", email);
                        showApp();
                    }
                } else {
                    els.err.style.color = "red";
                    els.err.innerText = data.message;
                }
            } catch (e) {
                els.err.innerText = "Request failed.";
            }
        };

        els.logoutBtn.onclick = () => logout();

        async function logout() {
            await fetch(API_BASE + "/logout", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            localStorage.clear();
            location.reload();
        }

    </script>
</body>
</html>
