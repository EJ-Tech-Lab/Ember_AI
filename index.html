<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f7f7f8; display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1; display: flex; justify-content: center; padding: 1em; }
    .chatbot { width: 100%; max-width: 700px; display: flex; flex-direction: column; border-radius: 10px; background-color: #ffffff; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
    .chat-header { padding: 1em; background-color: #7B58E5; color: #fff; }
    .chat-header h1 { margin: 0; font-size: 1.8em; }
    .chat-messages { flex: 1; padding: 1em; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5em; }
    .message { display: flex; align-items: flex-start; gap: 0.5em; }
    .user p { background-color: #7B58E5; color: #fff; padding: 0.3em 0.6em; border-radius: 20px 20px 0 20px; max-width: 90%; word-wrap: break-word; margin-left: auto; text-align: left; }
    .aibot p { background: #efefef; color: #000; padding: 0.4em 0.6em; border-radius: 20px 20px 20px 0; max-width: 90%; word-wrap: break-word; white-space: pre-wrap; }
    .chat-form { display: flex; padding: 1em; border-top: 1px solid #ddd; }
    .chat-form textarea { flex: 1; padding: 0.7em 1em; border-radius: 20px; border: 1px solid #ccc; resize: none; font-size: 1em; }
    .chat-form button { margin-left: 0.5em; background-color: #7B58E5; color: #fff; border: none; padding: 0.7em 1em; border-radius: 20px; cursor: pointer; }
    .chat-form button:hover { background-color: #5a3ecf; }
    .loading-text { font-style: italic; color: #555; }
    /* Login popup */
    #login-popup { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
    #login-card { background: white; padding: 20px; border-radius: 10px; width: 320px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    #login-card h3 { margin-bottom: 8px; }
    #login-card input { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; }
    #login-card button { margin-top: 12px; width: 100%; padding: 10px; border: none; background: #7B58E5; color: white; border-radius: 6px; cursor: pointer; }
    #login-error { color: red; margin-top: 10px; min-height: 18px; }
    .meta { font-size: 0.9em; color: #fff; margin-top: 6px; opacity: .9; }
  </style>
</head>
<body>
  <!-- LOGIN POPUP -->
  <div id="login-popup">
    <div id="login-card">
      <h3>Sign in</h3>
      <input id="login-user" placeholder="username" />
      <input id="login-pass" placeholder="password" type="password" />
      <button id="login-btn">Login</button>
      <p id="login-error"></p>
      
    </div>
  </div>

  <main>
    <div class="chatbot">
      <div class="chat-header"><h1>PeaðŸ«›</h1><div class="meta" id="who"></div></div>
      <div class="chat-messages" id="messages-container"></div>

      <form class="chat-form" id="message-form">
        <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
        <button type="button" id="mic-btn">ðŸŽ¤</button>
        <button type="submit">âž¤</button>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // ---- CONFIG: change this to your backend base URL ----
    const API_BASE = "https://ej-0-training.hf.space"; // or "http://localhost:8000"
    // ----------------------------------------------------

    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const micBtn = document.getElementById('mic-btn');

    const loginPopup = document.getElementById('login-popup');
    const loginBtn = document.getElementById('login-btn');
    const loginUser = document.getElementById('login-user');
    const loginPass = document.getElementById('login-pass');
    const loginError = document.getElementById('login-error');
    const whoEl = document.getElementById('who');

    let SESSION_ID = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recording = false;

    // Resize textarea auto
    messageInput.addEventListener('input', e => {
      e.target.style.height = 'auto';
      e.target.style.height = e.target.scrollHeight + 'px';
    });

    const addMessage = (message, role) => {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${role}`;

      const bubble = document.createElement('p');
      bubble.innerHTML = marked.parse(message);

      messageElement.appendChild(bubble);
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
    };

    // LOGIN
    loginBtn.onclick = async () => {
      loginError.innerText = "";
      const username = loginUser.value.trim();
      const password = loginPass.value.trim();
      if (!username || !password) {
        loginError.innerText = "Enter both username and password.";
        return;
      }

      try {
        const res = await fetch(API_BASE + "/login", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          SESSION_ID = data.session_id;
          loginPopup.style.display = "none";
          whoEl.innerText = `Signed in as: ${SESSION_ID}`;
          addMessage(`Welcome back, ${SESSION_ID}!`, 'aibot');
        } else {
          loginError.innerText = "Invalid username or password.";
        }
      } catch (err) {
        loginError.innerText = "Network or server error.";
        console.error(err);
      }
    };

    // SEND MESSAGE (with session_id)
    const sendMessage = async (message) => {
      if (!SESSION_ID) {
        addMessage("Please login first.", "aibot");
        return;
      }

      addMessage(message, 'user');

      const loading = document.createElement('p');
      loading.className = 'loading-text';
      loading.innerText = 'AI is typing...';
      messagesContainer.appendChild(loading);

      try {
        const response = await fetch(API_BASE + '/chatbot', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt: message, session_id: SESSION_ID })
        });

        const data = await response.json();
        loading.remove();
        addMessage(data.response || "No response", 'aibot');

      } catch (error) {
        loading.remove();
        addMessage(`Error: ${error}`, 'aibot');
      }
    };

    messageForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const message = messageInput.value.trim();
      if (!message) return;
      messageInput.value = '';
      await sendMessage(message);
    });

    // MICROPHONE (ASR)
    micBtn.addEventListener('click', async () => {
      if (!recording) {
        if (!navigator.mediaDevices?.getUserMedia) {
          alert("Microphone not supported.");
          return;
        }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        } catch (err) {
          console.error(err);
          addMessage("Microphone error.", "aibot");
          return;
        }

        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append('file', audioBlob, 'speech.webm');

          try {
            const res = await fetch(API_BASE + '/asr', {
              method: 'POST',
              body: formData
            });
            const data = await res.json();
            const text = data.text || "";
            messageInput.value = text;
            await sendMessage(text);
          } catch (err) {
            console.error(err);
            addMessage("Error recognizing speech.", 'aibot');
          }
        };

        mediaRecorder.start();
        micBtn.innerText = "â¹ï¸";
        recording = true;
      } else {
        mediaRecorder.stop();
        micBtn.innerText = "ðŸŽ¤";
        recording = false;
      }
    });

    // OPTIONAL: focus username input on load
    window.onload = () => loginUser.focus();
  </script>
</body>
</html>
